# Simulations gpu
seed = 123
import os
from sklearn.metrics import accuracy_score
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from torchsummary import summary
import random
import torch
random.seed(seed)     # python random generator
np.random.seed(seed)  # numpy random generator

torch.manual_seed(seed) # pytorch random generator
torch.cuda.manual_seed_all(seed) # for multi-gpu

torch.backends.cudnn.deterministic = True
torch.backends.cudnn.benchmark = False
#--------------------------------------------
from models.models_v3 import *
from utils.utils_semi import *
from utils.training import run_model_seq, num_param
#--------------------------------------------
path = os.getcwd()
folder_data = r'Data'
#-------------------------------
if torch.cuda.is_available():  
    device = "cuda:0" 
else:  
    device = "cpu"  
print('Your actual device',device)

#! Data settings
type_image = get_input('Enter an option (camel or cattle): ', str, ['camel', 'cattle'])
size = get_input('Enter the size of the image (128 or 256): ', int, [128, 256])
p = get_input('Enter the percentage of missing labels (0 to 100): ', int, range(101))

print(f"You entered: {type_image}, {size}, {p}")
#----------------------------------------------
# Path to save the model
path_data = os.path.join(path, folder_data, type_image+'_'+str(size))
print('Exist this folder', os.path.exists(path_data))
general_path  = os.path.join(os.getcwd(), 'Results_save_models') 
os.makedirs(general_path, exist_ok=True)
print('Saving our model in',general_path)
#----------------------------------------------
list_images = []
names_images = []
for data in sorted(os.listdir(path_data)):
    if data.endswith('.npy') and str(p) in data:
        list_images.append(np.load(os.path.join(path_data, data)))
        names_images.append(data[:-4])

while True:
    try:
        index = int(input(f"Enter an index from 0 to {len(list_images)-1}: "))
        if index < 0 or index >= len(list_images):
            raise ValueError
        break
    except ValueError:
        print('Invalid input. Please enter a valid index.')

name_image = names_images[index]
print('index', index, name_image)
image_x, y_true, image_y = list_images[index]

x = torch.tensor(image_x.reshape(size*size, 1), dtype=torch.float32)
y = torch.tensor(image_y.reshape(size*size, 1), dtype=torch.float32)
x = x.to(device)
y = y.to(device)
#----------------------------------------------
#! General model settings
x_dim = 1
y_dim = 1
weight_decay_ = 1e-4
clip = 10
add_loss =True # input("Enter 'True' if add_loss should be True, or 'False' otherwise: ").lower() == 'true'

learning_rate = get_input('Enter the learning rate: ', float)
n_epochs = get_input('Enter the number of epochs: ', int)
print_every = get_input('Enter the print interval: ', int)
save_every = get_input('Enter the save interval: ', int)
z_dim = get_input('Enter the value for z_dim: ', int)
h_dim = get_input('Enter the value for h_dim: ', int)
num_neurons = get_input('Enter the value for num_neurons: ', int)
sel_model = get_input('Enter the model (tmm, vls, svrnn): ', str).lower()
epoch_init = get_input('Enter the value for epoch_init (from 1 to --): ', int)
setting = '' if add_loss else 'no_add'




if sel_model == 'tmm':
    model = TMM(x_dim, z_dim, y_dim, h_dim, num_neurons, device, add_loss)
if sel_model == 'vls':
    model = VSL( x_dim, z_dim, y_dim, h_dim, num_neurons, device)
if sel_model == 'svrnn':
    model = SVRNN(x_dim, z_dim, h_dim, y_dim, num_neurons, device, add_loss)

#--------------------------------------------
# Save models
#--------------------------------------------
model.to(device)
optimizer = torch.optim.Adam(model.parameters(), lr=learning_rate, weight_decay= weight_decay_)

data = model.__class__.__name__.casefold()+'_'+name_image+setting
path_save = os.path.join(general_path, data)
os.makedirs(path_save, exist_ok=True)


print(f'Actual path to save our models for {data} is \n {path_save} \n')
print( f'epoch_init = {epoch_init}, z_dim = {z_dim}, num_neurons = {num_neurons}, h_dim = {h_dim}, add_loss = {add_loss}, learning_rate = {learning_rate}, n_epochs = {n_epochs}, print_every = {print_every}, save_every = {save_every}, model = {model.__class__.__name__}')

input('Press enter to continue: ')
#* Training
loss = run_model_seq(x, y,model,optimizer,clip, path_save, n_epochs,save_every, print_every)
plt.plot(loss)
plt.xlabel('Epochs')
plt.ylabel('Loss')
plt.title('Loss of ' + data+ ' with ' + str(n_epochs) + ' epochs')
plt.savefig(os.path.join(path_save, data + '_loss_' + str(n_epochs) +'.png'))
plt.show()
plt.close()

with open(os.path.join(path_save,'output.txt'), 'w') as f:
    print(f'image ={name_image}, epoch_init = {epoch_init}, z_dim = {z_dim}, num_neurons = {num_neurons}, h_dim = {h_dim}, add_loss = {add_loss}, learning_rate = {learning_rate}, n_epochs = {n_epochs}, print_every = {print_every}, save_every = {save_every}, model = {model.__class__.__name__}', file=f)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            